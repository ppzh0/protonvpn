import{x as I}from"./x-pm-appversion.eUjl4QB8.js";const y=()=>crypto.randomUUID(),b=async(e,t,r,i)=>{const n=document?.referrer?{"X-PM-Referer":document.referrer}:{},d=r?{"x-pm-uid":r}:{},l=i?.headers instanceof Headers?Object.fromEntries(i.headers.entries()):i?.headers||{};return fetch(e,{...i,credentials:"include",headers:{...l,...n,...d,"Content-Type":"application/json;charset=utf-8",Accept:"application/vnd.protonmail.v1+json","x-pm-appversion":t}})},M=e=>e.includes("/support")?"support_kb":e.includes("/blog")?"blog":e.includes("/legal/")?"legal":e.includes("/pricing")?"pricing":e.includes("/download")?"download":e.includes("/l/")?"landing_page":"other",V=()=>{const e=new Date().getTimezoneOffset(),t=e<=0?"+":"-",r=String(Math.floor(Math.abs(e)/60)).padStart(2,"0"),i=String(Math.abs(e)%60).padStart(2,"0");return`UTC${t}${r}:${i}`},k=()=>{const e={};return document.querySelectorAll('meta[name^="ab-test:"]').forEach(r=>{const i=r.getAttribute("name"),n=r.getAttribute("content");if(i&&n){const d=i.replace("ab-test:","");e[d]=n}}),e},x=e=>{if(!e)return;const t=e.getAttribute("aria-label");if(t)return f(t);const r=e.getAttribute("title");if(r)return f(r);const i=e.getAttribute("alt");if(i)return f(i);const n=e.getAttribute("name");if(n)return f(n);if((e instanceof HTMLInputElement||e instanceof HTMLButtonElement||e instanceof HTMLSelectElement)&&e.value)return f(e.value);const d=O(e);if(d&&d.textContent)return f(d.textContent.trim());const l=e.getAttribute("data-text");if(l)return f(l);if(e.tagName.toLowerCase()==="a"||e.tagName.toLowerCase()==="button"){const s=e.querySelector("img");if(s?.alt)return f(s.alt)}let a=Array.from(e.childNodes).filter(s=>s.nodeType===Node.TEXT_NODE).map(s=>s.textContent).join(" ").trim();if(!a&&(a=e.textContent?.trim()||"",a.includes("(function")||a.includes("window.localStorage")||a.includes("document.currentScript")||a.includes("addEventListener(")||a.includes("{")&&a.includes("}")&&a.includes(";"))){const s=a.split(/\(function|\{|\}|;/)[0].trim();return f(s||e.tagName.toLowerCase()+" element with JS code")}return f(a)},f=e=>e?e.substring(0,100):void 0;function O(e){let t=e.previousElementSibling;for(;t;){if(/^h[1-6]$/i.test(t.tagName))return t;t=t.previousElementSibling}const r=e.parentElement;if(r){const i=r.querySelector("h1, h2, h3, h4, h5, h6");if(i)return i}return null}const N=(e,t,r,i)=>{const n={pageStartTime:performance.now(),activeStartTime:document.hidden?null:performance.now(),totalActiveTime:0,isPageVisible:!document.hidden};function d(){n.pageStartTime=performance.now(),n.activeStartTime=document.hidden?null:n.pageStartTime,n.totalActiveTime=0,n.isPageVisible=!document.hidden}function l(){const o=performance.now();n.isPageVisible=!document.hidden,document.hidden?n.activeStartTime!==null&&(n.totalActiveTime+=o-n.activeStartTime,n.activeStartTime=null):n.activeStartTime=o}function a(){if(!i())return;const o=performance.now(),u=o-n.pageStartTime;n.isPageVisible&&n.activeStartTime!==null&&(n.totalActiveTime+=o-n.activeStartTime),e("exit",{timeOnPage:Math.round(u),activeTime:Math.round(n.totalActiveTime)})}function s(o){const u=o.target;if(!u)return;const m=typeof o.pageX=="number"?o.pageX:0,g=typeof o.pageY=="number"?o.pageY:0,p={elementType:u.tagName.toLowerCase(),elementId:u.id||void 0,elementText:x(u),elementHref:u.href||void 0,xPos:m,yPos:g};e("click",p)}function c(o){o.target&&e("form_submit")}return document.addEventListener&&(document.addEventListener("visibilitychange",l),window.addEventListener("beforeunload",a),window.addEventListener("pagehide",a)),d(),{sendPageView:()=>{if(!r.pageView)return;n.pageStartTime&&n.totalActiveTime>0&&a(),d();const o={pageTitle:document.title,pageType:M(window.location.pathname),path:window.location.pathname,referrer:document.referrer};e("page_view",o,{features:k()})},initClickSending:()=>{r.click&&document.addEventListener("click",s)},initFormSending:()=>{r.form&&document.addEventListener("submit",c)},sendModalView:(o,u)=>{if(!r.modal)return;const m={modalId:o,modalType:u,timeToShow:Math.round(performance.now()-t)};e("modal_view",m)},destroy:()=>{document.removeEventListener("visibilitychange",l),window.removeEventListener("beforeunload",a),window.removeEventListener("pagehide",a),r.click&&document.removeEventListener("click",s),r.form&&document.removeEventListener("submit",c)}}};function R(e){return{initializeObserver:()=>{new PerformanceObserver(r=>{r.getEntries().forEach(i=>{if(i.entryType==="navigation"){const n=i,d={pageLoadTime:Math.round(n.loadEventEnd-n.startTime),dnsTime:Math.round(n.domainLookupEnd-n.domainLookupStart),tcpTime:Math.round(n.connectEnd-n.connectStart),ttfb:Math.round(n.responseStart-n.requestStart)};e("performance",d)}})}).observe({entryTypes:["navigation"]})}}}const H=200,T=3;function _(e,t,r){async function i(d){let l;const a=!!d;if(a?l=d:l=t.eventQueue.splice(0,t.eventQueue.length).map(c=>c.event),l.length===0)return!0;try{const s=await b(e.endpoint,e.appVersion,e.uidHeader,{method:"POST",body:JSON.stringify({events:l}),keepalive:!0});if(s.ok)return e.debug&&t.retryCount>0&&a&&console.log("[Telemetry] Batch sent successfully after retries."),a&&(t.retryCount=0),!0;const c=s.headers.get("retry-after");if((s.status===429||s.status===503)&&c){const u=parseInt(c,10),m=!isNaN(u)&&u>=0?u*1e3:null;return m!==null&&t.retryCount<T?(t.retryCount++,e.debug&&console.log(`[Telemetry] Server responded with ${s.status}. Retrying after ${m}ms (attempt #${t.retryCount}) based on Retry-After header.`),setTimeout(()=>{i(l)},m),!1):(e.debug&&console.error(m===null?`[Telemetry] Server responded with ${s.status} but invalid Retry-After header ('${c}'). Dropping events.`:`[Telemetry] Max retries (${T}) reached after ${s.status} response. Dropping events.`),t.retryCount=0,!1)}else return e.debug&&console.error(`[Telemetry] Server responded with status ${s.status} without a valid Retry-After header. Dropping events.`),t.retryCount=0,!1}catch(s){return e.debug&&console.error("[Telemetry] Network error occurred. Dropping events.",s),t.retryCount=0,!1}}async function n(d,l,a,s="high"){const c=r.createEventPayload(d,l,a);return e.dryRun?(console.log("[DRY RUN] event:",c),!0):(t.eventQueue.push({event:c,priority:s}),t.batchTimeout===null&&t.retryCount===0?new Promise(o=>{t.batchTimeout=setTimeout(async()=>{t.batchTimeout=null,o(await i())},H)}):Promise.resolve(!0))}return n}const w={debug:!1,dryRun:!1,events:{pageView:!0,click:!0,form:!1,performance:!0,visibility:!0,modal:!1}},$=e=>({...w,...e,events:{...w.events,...e.events}}),D=e=>{const t=$(e),r={aId:"",pageLoadTime:0,userTimezone:"",userLanguage:"",isInitialized:!1,eventQueue:[],batchTimeout:null,retryCount:0};function i(){const c=navigator.doNotTrack||window.doNotTrack,o=navigator.globalPrivacyControl,u=!(c==="1"||c==="yes"||o===!0);return!u&&localStorage.getItem("aId")&&localStorage.removeItem("aId"),u}const n=_({endpoint:t.endpoint,appVersion:t.appVersion,debug:t.debug,dryRun:t.dryRun,uidHeader:t.uidHeader},{eventQueue:r.eventQueue,batchTimeout:r.batchTimeout,retryCount:r.retryCount},{createEventPayload:d});function d(c,o,u){const m=new URLSearchParams(window.location.search),g={};m.forEach((A,h)=>{h.startsWith("utm_")&&(g[h]=A)});const p=new Date,S=p.toISOString().replace("Z","+00:00"),v=-p.getTimezoneOffset(),E=Math.floor(Math.abs(v)/60).toString().padStart(2,"0"),C=(Math.abs(v)%60).toString().padStart(2,"0"),L=v>=0?"+":"-",P=new Date(p.getTime()-p.getTimezoneOffset()*6e4).toISOString().replace("Z",`${L}${E}:${C}`);return{aId:r.aId,messageId:y(),clientEventTimestampUtc:S,clientEventTimestampLocal:P,eventType:c,context:{campaign:{name:m.get("utm_campaign")||"",source:m.get("utm_source")||"",medium:m.get("utm_medium")||"",term:m.get("utm_term")||"",content:m.get("utm_content")||""},library:{name:"proton-telemetry",version:t.appVersion},browserLocale:r.userLanguage,page:{title:document.title,url:window.location.href,path:window.location.pathname,referrer:document.referrer,queryString:window.location.search,queryParams:g},referrer:{type:"",name:"",url:document.referrer},screen:{width:window.screen.width,height:window.screen.height,density:Number(window.devicePixelRatio.toFixed(2))},timezone:r.userTimezone,userAgent:navigator.userAgent,features:u?.features||Object.create(null)},properties:{...o||{},data:u}}}function l(){const c="aId",o=localStorage.getItem(c);if(o)return r.aId=o,o;const u=y();return localStorage.setItem(c,u),r.aId=u,n("random_uid_created",{},void 0,"low"),u}i()&&(r.aId=l(),r.pageLoadTime=performance.now(),r.userTimezone=V(),r.userLanguage=navigator.language||"en");const a=N(n,r.pageLoadTime,{pageView:!!t.events.pageView,click:!!t.events.click,form:!!t.events.form,modal:!!t.events.modal},i),s=R(n);return i()&&(t.events.pageView&&a.sendPageView(),t.events.click&&a.initClickSending(),t.events.performance&&s.initializeObserver()),{sendPageView:()=>{i()&&a.sendPageView()},sendClicks:()=>{i()&&a.initClickSending()},sendForms:()=>{i()&&a.initFormSending()},sendModalView:(c,o)=>{i()&&a.sendModalView(c,o)},sendCustomEvent:(c,o)=>{i()&&n(c,{},o)},destroy:async()=>{if(r.eventQueue.length>0){const c={events:r.eventQueue.map(o=>o.event)};try{await b(t.endpoint,t.appVersion,t.uidHeader,{method:"POST",body:JSON.stringify(c),keepalive:!0}),r.eventQueue=[]}catch(o){t.debug&&console.error("Telemetry error:",o)}}a.destroy()}}},z=e=>{switch(e){case"protonvpn-com":return"https://telemetry.protonvpn.com/payload";case"lumo-proton-me":case"proton-me":default:return"https://telemetry.proton.me/payload"}},Q=z("protonvpn-com"),B=D({endpoint:Q,debug:!1,appVersion:I});window.protonTelemetry=B;
